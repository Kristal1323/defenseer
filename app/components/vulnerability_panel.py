import streamlit as st
from backend.analyzer import run_bandit_on_file
from backend.classifier import predict_with_confidence
from backend.project_manager import get_full_path


def vuln_badge(label: str, conf: float):
    """
    Returns a colored badge for Real Issue / False Positive.
    """
    if label == "real":
        return f"üõë **Real Issue** ‚Äî ({conf:.1f}%)"
    else:
        return f"‚ö™ **Likely False Positive** ‚Äî ({conf:.1f}%)"


def vulnerability_panel(project_state, pasted_code: str):
    st.subheader("üîç Security Scan Results")

    # Friendly overrides for common Bandit rule IDs. Falls back to Bandit's own
    # issue_text so any new rule still shows a human-readable label.
    rule_labels = {
        "B403": "Uses insecure pickle modules",
        "B311": "Uses insecure random generator",
        "B608": "Possible SQL injection via string formatting",
        "B105": "Hardcoded password string",
        "B324": "Weak hash algorithm (MD5/SHA1)",
        "B605": "Shell execution with user input (os.system)",
        "B301": "Insecure deserialization (pickle.loads)",
        "B501": "Unsafe requests call without verification",
        "B303": "Weak crypto cipher or mode",
        "B306": "Base64 or hex decode of untrusted input",
        "B317": "XML parsing could be unsafe",
        "B602": "Subprocess call with shell=True",
    }

    file_path = None
    project_name = project_state.get("project_name")
    active_file = project_state.get("active_file")
    if project_name and active_file:
        file_path = get_full_path(project_name, active_file)

    has_pasted_code = bool(pasted_code and pasted_code.strip())

    if not file_path and not has_pasted_code:
        st.info("Upload a file or paste code to begin analysis.")
        return

    if st.button("Run Security Scan", type="primary"):
        with st.spinner("Analyzing for vulnerabilities..."):
            try:
                if file_path:
                    issues = run_bandit_on_file(file_path)
                else:
                    # Save pasted code to temp
                    tmp_path = "tmp_pasted_code.py"
                    with open(tmp_path, "w") as f:
                        f.write(pasted_code)
                    issues = run_bandit_on_file(tmp_path)
            except Exception as e:
                st.error(f"Failed to analyze code: {e}")
                return

        if not issues:
            st.success("üéâ No vulnerabilities detected!")
            return

        st.write(f"### üß© Found {len(issues)} potential issues")

        for issue in issues:
            rule_id = issue.get("test_id", "N/A")
            msg = issue.get("issue_text", "No description")
            friendly_label = rule_labels.get(rule_id, msg)
            line = issue.get("line_number", "?")
            severity = issue.get("issue_severity", "?")
            code_snippet = issue.get("code", "").strip()

            # ML prediction
            label, conf = predict_with_confidence(msg)

            with st.container():
                st.markdown("---")
                st.markdown(f"### {vuln_badge(label, conf)}")

                cols = st.columns(2)
                with cols[0]:
                    st.markdown(f"**Rule:** `{rule_id}`")
                    st.markdown(f"**Label:** {friendly_label}")
                    st.markdown(f"**Severity:** `{severity}`")
                    st.markdown(f"**Line:** `{line}`")

                with cols[1]:
                    st.markdown("**ML Classification:**")
                    if label == "real":
                        st.markdown(
                            f"<span style='color:#ff4d4f; font-weight:600;'>Real Issue</span>",
                            unsafe_allow_html=True,
                        )
                    else:
                        st.markdown(
                            f"<span style='color:#888; font-weight:600;'>False Positive</span>",
                            unsafe_allow_html=True,
                        )
                    st.markdown(f"**Confidence:** {conf:.1f}%")

                if code_snippet:
                    st.markdown("**Code Snippet:**")
                    st.code(code_snippet, language="python")

        st.markdown("---")
        st.info("ML classifier helps suppress noise and highlight the most critical vulnerabilities.")
