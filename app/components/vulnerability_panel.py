import streamlit as st
from backend.analyzer import run_bandit_on_file, run_bandit_on_code
from backend.project_manager import get_full_path
from backend.classifier import ml_classifier


def vulnerability_panel(project_state, pasted_code):
    project_name = project_state["project_name"]
    active_file = project_state["active_file"]

    if st.button("ğŸ” Run Security Scan", use_container_width=True):
        st.write("Running Bandit analysis...")

        # Choose file or pasted code
        if active_file:
            file_path = get_full_path(project_name, active_file)
            issues = run_bandit_on_file(file_path)
        else:
            issues = run_bandit_on_code(project_name, pasted_code)

        # Apply ML classifier
        for issue in issues:
            issue["ml_label"] = ml_classifier.classify(issue["text"])

        st.session_state["scan_results"] = issues

    # Display results
    issues = st.session_state.get("scan_results")
    if not issues:
        st.info("No scan results yet. Click 'Run Security Scan'.")
        return

    if len(issues) == 0:
        st.success("No vulnerabilities found ğŸ‰")
        return

    for issue in issues:
        with st.container():
            severity_color = (
                "ğŸ”´" if issue["severity"] == "HIGH" else
                "ğŸŸ " if issue["severity"] == "MEDIUM" else
                "ğŸŸ¡"
            )

            ml_badge = (
                "ğŸ§  Real Issue" if issue["ml_label"] == "real"
                else "ğŸ¤– Likely False Positive"
            )

            st.markdown(
                f"""
                ### {severity_color} {issue['test_id']} â€” {issue['test_name']}
                **Severity:** {issue['severity']}  
                **Confidence:** {issue['confidence']}  
                **ML Classification:** {ml_badge}  
                **File:** `{issue['filename']}`  
                **Line:** `{issue['line_number']}`
                """
            )

            if issue["text"]:
                st.write(f"**Description:** {issue['text']}")

            if issue["code"]:
                st.code(issue["code"], language="python")

            st.divider()
