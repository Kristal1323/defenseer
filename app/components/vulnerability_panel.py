import streamlit as st
from backend.analyzer import run_bandit_on_file, run_bandit_on_code
from backend.project_manager import get_full_path


def vulnerability_panel(project_state, pasted_code):
    """
    Runs Bandit security scan on either:
    - Selected project file, or
    - Pasted code

    Displays parsed vulnerability entries.
    """
    project_name = project_state["project_name"]
    active_file = project_state["active_file"]

    if st.button("ğŸ” Run Security Scan", use_container_width=True):
        st.write("Running Bandit analysis...")

        # Run scan on selected file
        if active_file:
            file_path = get_full_path(project_name, active_file)
            issues = run_bandit_on_file(file_path)

        # Run scan on pasted code
        else:
            issues = run_bandit_on_code(project_name, pasted_code)

        st.session_state["scan_results"] = issues

    # Display results
    issues = st.session_state.get("scan_results")
    if not issues:
        st.info("No scan results yet. Click 'Run Security Scan' to begin.")
        return

    if len(issues) == 0:
        st.success("No vulnerabilities found ğŸ‰")
        return

    for issue in issues:
        with st.container():
            severity_color = "ğŸ”´" if issue["severity"] == "HIGH" else (
                "ğŸŸ " if issue["severity"] == "MEDIUM" else "ğŸŸ¡"
            )

            st.markdown(
                f"""
                ### {severity_color} {issue['test_id']} â€” {issue['test_name']}
                **Severity:** {issue['severity']}  
                **Confidence:** {issue['confidence']}  
                **File:** `{issue['filename']}`  
                **Line:** `{issue['line_number']}`
                """
            )

            if issue["text"]:
                st.write(f"**Description:** {issue['text']}")

            if issue["code"]:
                st.code(issue["code"], language="python")

            st.divider()
